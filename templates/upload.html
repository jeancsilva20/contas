{% extends "base.html" %}

{% block title %}Upload de Arquivos - {{ super() }}{% endblock %}

{% block header %}Upload de Fatura/Extrato{% endblock %}

{% block content %}
<div class="card">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="password">Senha do arquivo:</label>
            <md-filled-text-field 
                id="password" 
                name="password" 
                type="password" 
                label="Digite a senha"
                required>
            </md-filled-text-field>
        </div>

        <div class="form-group">
            <label for="file">Selecionar arquivo (.xlsx/.csv):</label>
            <div class="file-input-wrapper">
                <input 
                    type="file" 
                    id="file" 
                    name="file" 
                    class="file-input" 
                    accept=".xlsx,.csv,.xls"
                    required
                >
                <label for="file" class="file-input-label">
                    Escolher arquivo
                </label>
                <div class="file-name" id="fileName"></div>
            </div>
        </div>

        <md-filled-button id="submitBtn" type="submit">
            Importar
        </md-filled-button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file');
    const fileName = document.getElementById('fileName');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');

    // Atualizar nome do arquivo selecionado
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            fileName.textContent = 'Arquivo selecionado: ' + this.files[0].name;
        } else {
            fileName.textContent = '';
        }
    });

    // Processar envio do formulário
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(uploadForm);
        const password = document.getElementById('password').value;
        const file = fileInput.files[0];

        // Validações básicas
        if (!password) {
            Notiflix.Notify.failure('Por favor, digite a senha do arquivo');
            return;
        }

        if (!file) {
            Notiflix.Notify.failure('Por favor, selecione um arquivo');
            return;
        }

        // Mostrar loading
        Notiflix.Loading.circle('Processando arquivo...');

        // Simular processamento
        fetch('/process_upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            Notiflix.Loading.remove();

            if (data.success) {
                Notiflix.Notify.success(data.message);
                // Limpar formulário
                uploadForm.reset();
                fileName.textContent = '';
            } else {
                Notiflix.Notify.failure(data.message);
            }
        })
        .catch(error => {
            Notiflix.Loading.remove();
            Notiflix.Notify.failure('Erro ao processar arquivo: ' + error.message);
        });
    });
});
</script>
{% endblock %}